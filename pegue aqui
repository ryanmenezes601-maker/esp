--// CONFIGURAÇÃO INICIAL
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--// VARIÁVEIS E OPÇÕES
local menuVisible = false
local options = {
    box = true,
    skeleton = true,
    rgb = true,
    name = true,
    distance = true,
    fixedColor = Color3.fromRGB(255, 0, 0),
    font = "UI",
}

local availableFonts = {
    UI = 0,
    System = 1,
    Plex = 2,
    Monospace = 3,
    Cartoon = 4,
}

--// MENU (tecla L)
local function createMenu()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ESP_Menu"
    screenGui.Parent = game.CoreGui

    local frame = Instance.new("Frame", screenGui)
    frame.Position = UDim2.new(0, 20, 0, 100)
    frame.Size = UDim2.new(0, 190, 0, 220)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BorderSizePixel = 0
    frame.Visible = menuVisible

    local function createToggle(name, y, default)
        local toggle = Instance.new("TextButton", frame)
        toggle.Position = UDim2.new(0, 10, 0, y)
        toggle.Size = UDim2.new(0, 160, 0, 24)
        toggle.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        toggle.TextColor3 = Color3.new(1, 1, 1)
        toggle.Text = name .. ": " .. (default and "ON" or "OFF")
        toggle.TextSize = 14
        toggle.MouseButton1Click:Connect(function()
            options[name:lower()] = not options[name:lower()]
            toggle.Text = name .. ": " .. (options[name:lower()] and "ON" or "OFF")
        end)
    end

    createToggle("Box", 8, options.box)
    createToggle("Skeleton", 36, options.skeleton)
    createToggle("RGB", 64, options.rgb)
    createToggle("Name", 92, options.name)
    createToggle("Distance", 120, options.distance)

    local colorButton = Instance.new("TextButton", frame)
    colorButton.Position = UDim2.new(0, 10, 0, 148)
    colorButton.Size = UDim2.new(0, 160, 0, 24)
    colorButton.BackgroundColor3 = options.fixedColor
    colorButton.Text = "Cor fixa"
    colorButton.TextColor3 = Color3.new(1, 1, 1)
    colorButton.MouseButton1Click:Connect(function()
        local r, g, b = math.random(0, 255), math.random(0, 255), math.random(0, 255)
        options.fixedColor = Color3.fromRGB(r, g, b)
        colorButton.BackgroundColor3 = options.fixedColor
    end)

    local fontButton = Instance.new("TextButton", frame)
    fontButton.Position = UDim2.new(0, 10, 0, 176)
    fontButton.Size = UDim2.new(0, 160, 0, 24)
    fontButton.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    fontButton.Text = "Fonte: " .. options.font
    fontButton.TextColor3 = Color3.new(1, 1, 1)

    local fontList = {"UI", "System", "Plex", "Monospace", "Cartoon"}
    local currentFontIndex = 1

    fontButton.MouseButton1Click:Connect(function()
        currentFontIndex = currentFontIndex % #fontList + 1
        options.font = fontList[currentFontIndex]
        fontButton.Text = "Fonte: " .. options.font
    end)

    return frame
end

local menu = createMenu()

-- Alternar menu com tecla L
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.L then
        menuVisible = not menuVisible
        menu.Visible = menuVisible
    end
end)

--// DRAWING UTILITIES
local function createBox()
    local b = Drawing.new("Square")
    b.Thickness = 1
    b.Transparency = 1
    b.Filled = false
    b.Color = Color3.fromRGB(255, 0, 0)
    b.Visible = false
    return b
end

local function createLine()
    local l = Drawing.new("Line")
    l.Thickness = 1
    l.Transparency = 1
    l.Color = Color3.fromRGB(255, 0, 0)
    l.Visible = false
    return l
end

local function createText()
    local t = Drawing.new("Text")
    t.Size = 14
    t.Color = Color3.fromRGB(255, 255, 255)
    t.Center = true
    t.Outline = true
    t.Visible = false
    t.Font = 0
    return t
end

local function getRGBColor()
    local t = tick() * 2
    return Color3.fromHSV(t % 1, 1, 1)
end

--// ESP TABLE
local ESP = {}

local function cleanupPlayerESP(player)
    local data = ESP[player]
    if data then
        for _, obj in pairs(data) do
            if typeof(obj) == "table" then
                for _, sub in ipairs(obj) do pcall(function() sub:Remove() end) end
            else
                pcall(function() obj:Remove() end)
            end
        end
        ESP[player] = nil
    end
end

Players.PlayerRemoving:Connect(cleanupPlayerESP)

--// ATUALIZAÇÃO DO ESP
RunService.RenderStepped:Connect(function()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if not ESP[player] then
                ESP[player] = {
                    box = createBox(),
                    lines = {},
                    nameText = createText(),
                    distText = createText(),
                }
                for i = 1, 15 do table.insert(ESP[player].lines, createLine()) end
            end

            local data = ESP[player]
            local hrp = player.Character.HumanoidRootPart
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            local pos3, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            local color = options.rgb and getRGBColor() or options.fixedColor

            -- CAIXA
            if options.box and onScreen then
                local height = 2500 / pos3.Z
                local width = height / 2
                data.box.Position = Vector2.new(pos3.X - width / 2, pos3.Y - height / 2)
                data.box.Size = Vector2.new(width, height)
                data.box.Color = color
                data.box.Visible = true
            else
                data.box.Visible = false
            end

            -- NOME E DISTÂNCIA
            data.nameText.Font = availableFonts[options.font] or 0
            data.distText.Font = availableFonts[options.font] or 0

            if options.name and onScreen then
                data.nameText.Text = player.Name
                data.nameText.Position = Vector2.new(pos3.X, pos3.Y - (data.box.Size.Y / 2) - 14)
                data.nameText.Color = color
                data.nameText.Visible = true
            else
                data.nameText.Visible = false
            end

            if options.distance and onScreen then
                local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                local dist = root and (root.Position - hrp.Position).Magnitude or 0
                data.distText.Text = string.format("%.1f m", dist)
                data.distText.Position = Vector2.new(pos3.X, pos3.Y + (data.box.Size.Y / 2) + 14)
                data.distText.Color = Color3.fromRGB(200, 200, 200)
                data.distText.Visible = true
            else
                data.distText.Visible = false
            end
        else
            if ESP[player] then cleanupPlayerESP(player) end
        end
    end
end)
